import numpy as np
import pandas as pd

configfile: "config/config.yml"

FIPY_PATH = "/Users/guyer/Documents/research/FiPy/fipy"
SUITES = ["petsc"]
# calculate dimensions that produce six orders of magnitude in number of cells
# SIZES = (10**(np.arange(1, 6.5, 1.)/2)).round().astype(int)**2
SIZES = (10**(np.arange(1, 2.5, 1.)/2)).round().astype(int)**2
# BENCHMARKS = ["binary_phase_field", "diffusion", "nucleation"]
BENCHMARKS = ["binary_phase_field"]

include: "rules/common.smk"
include: "rules/aggregate.smk"
include: "rules/permutations.smk"
include: "rules/logs.smk"
include: "rules/solve.smk"
include: "rules/plot_scaling.smk"

report: "report/workflow.rst"

permutations = pd.read_csv("config/permutations.csv", index_col="uuid")

rule all:
    input:
        "results/all.json",
        "results/total_times.json",
        get_all_plots

rule aggregate_results:
    output:
        "results/all.json"
    input:
        logs=expand("results/{id}/solver.json",
                    id=permutations.index)
    log:
        "results/all.log"
    run:
        concat_json(input.logs, output[0], log[0])

